<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานเจ้าหนี้และสรุปประเภทค่าใช้จ่าย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; transition: background-color 0.3s ease; }
        .dark body { background-color: #0f172a; }
        .dark .bg-white { background-color: #1e293b; border-color: #334155; }
        .dark .text-gray-800 { color: #f1f5f9; }
        .dark .bg-gray-50 { background-color: #0f172a; }
        .dark .border-gray-100 { border-color: #334155; }
        .dark input, .dark select { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
        .table-bordered th, .table-bordered td { border: 1px solid #e2e8f0; }
        .dark .table-bordered th, .dark .table-bordered td { border: 1px solid #334155; }
        
        /* Custom Scrollbar for Multi-select */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-50 transition-colors duration-300">

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex flex-col">
                <h1 class="text-2xl font-bold text-gray-800">ระบบรายงานเจ้าหนี้แยกประเภท ✨</h1>
                <p class="text-indigo-600 font-semibold text-sm italic">จัดการข้อมูลและค้นหาขั้นสูง</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-3">
                <button id="syncCloudBtn" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl transition shadow-md">
                    <i data-lucide="refresh-cw" class="w-5 h-5" id="syncIcon"></i>
                    <span>อัปเดตข้อมูล</span>
                </button>
                <button id="darkModeToggle" class="p-2.5 rounded-xl border border-gray-200 dark:border-slate-700 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
                    <i data-lucide="moon" id="moonIcon" class="w-5 h-5"></i>
                    <i data-lucide="sun" id="sunIcon" class="w-5 h-5 hidden"></i>
                </button>
            </div>
        </div>

        <!-- Filters Section (Updated) -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
            <div class="flex items-center gap-2 mb-2 border-b pb-2">
                <i data-lucide="search" class="text-indigo-500 w-5 h-5"></i>
                <h2 class="font-bold text-gray-700 dark:text-gray-200">ค้นหาและกรองข้อมูล</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- 1. ค้นหาบริษัท -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">1. ชื่อบริษัท/เจ้าหนี้</label>
                    <div class="relative">
                        <i data-lucide="building-2" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="searchCreditor" placeholder="พิมพ์ชื่อบริษัท..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-xl outline-none text-sm w-full focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                </div>

                <!-- 2. เลขที่ใบแจ้งหนี้ -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">2. เลขที่ใบแจ้งหนี้/ใบส่งของ</label>
                    <div class="relative">
                        <i data-lucide="hash" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="searchInvoice" placeholder="พิมพ์เลขที่บิล..." class="pl-10 pr-4 py-2 border border-gray-200 rounded-xl outline-none text-sm w-full focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                </div>

                <!-- 4. สถานะ (ย้ายมาไว้ข้างหน้าเพื่อให้ 3. กินพื้นที่ได้เยอะกว่า) -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">4. สถานะการชำระ</label>
                    <select id="filterStatus" class="px-4 py-2 border border-gray-200 rounded-xl outline-none text-sm w-full focus:ring-2 focus:ring-indigo-500">
                        <option value="All">ทุกสถานะ</option>
                        <option value="Paid">จ่ายครบแล้ว</option>
                        <option value="Unpaid">ยังไม่จ่าย</option>
                    </select>
                </div>

                <!-- 3. ประเภทค่าใช้จ่าย (Multi-select) -->
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">3. ประเภทค่าใช้จ่าย (เลือกได้ > 1)</label>
                    <div class="relative group">
                        <div id="expenseTypeDropdownBtn" class="flex justify-between items-center px-4 py-2 border border-gray-200 rounded-xl cursor-pointer text-sm bg-white dark:bg-slate-800">
                            <span id="selectedExpenseLabel" class="truncate text-gray-500">ทั้งหมด</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                        <!-- Dropdown Menu -->
                        <div id="expenseMenu" class="hidden absolute left-0 right-0 mt-2 bg-white dark:bg-slate-800 border border-gray-200 rounded-xl shadow-xl z-50 max-h-60 overflow-y-auto custom-scrollbar p-2">
                            <label class="flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg cursor-pointer transition-colors border-b mb-1">
                                <input type="checkbox" id="checkAllExpenses" checked class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500">
                                <span class="text-xs font-bold">เลือกทั้งหมด</span>
                            </label>
                            <div id="expenseCheckboxes" class="space-y-1">
                                <!-- Dynamic checkboxes -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">ยอดหนี้รวม</p>
                <h3 id="statTotal" class="text-2xl font-bold text-gray-800">0.00</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">จ่ายแล้ว</p>
                <h3 id="statPaid" class="text-2xl font-bold text-green-600">0.00</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-orange-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">ปรับปรุงเจ้าหนี้</p>
                <h3 id="statAdjustment" class="text-2xl font-bold text-orange-600">0.00</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-red-500">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">คงเหลือสุทธิ</p>
                <h3 id="statBalance" class="text-2xl font-bold text-red-600">0.00</h3>
            </div>
        </div>

        <!-- Expense Summary Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b bg-indigo-50 dark:bg-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-2 font-bold text-indigo-900 dark:text-indigo-200">
                    <i data-lucide="list-checks" class="w-5 h-5"></i>
                    สรุปตามประเภทค่าใช้จ่าย
                </div>
            </div>
            <div class="overflow-x-auto p-4">
                <table class="w-full text-sm text-left table-bordered border-collapse">
                    <thead class="bg-gray-100 dark:bg-slate-700">
                        <tr class="text-gray-700 dark:text-gray-200">
                            <th class="p-3">1. ประเภทค่าใช้จ่าย</th>
                            <th class="p-3 text-center">2. จำนวนรายการ</th>
                            <th class="p-3 text-right">3. จ่ายแล้ว</th>
                            <th class="p-3 text-right">4. ปรับปรุง</th>
                            <th class="p-3 text-right text-red-600">5. คงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody" class="divide-y divide-gray-100 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>

        <!-- Details Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 border-b bg-gray-50 dark:bg-slate-800 flex items-center justify-between">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-indigo-500"></i>
                    รายละเอียดรายการ
                </h3>
            </div>
            <div class="p-4 overflow-x-auto">
                <table class="w-full text-left text-xs table-bordered border-collapse">
                    <thead>
                        <tr class="text-gray-600 font-bold bg-gray-100 dark:bg-slate-700">
                            <th class="p-3">วันที่รับ</th>
                            <th class="p-3">ชื่อเจ้าหนี้ / เลขบิล</th>
                            <th class="p-3 text-right">1. จำนวนเงิน</th>
                            <th class="p-3 text-right text-green-600">2. จ่าย</th>
                            <th class="p-3 text-right text-orange-500">3. ปรับปรุง</th>
                            <th class="p-3 text-right text-red-600 font-bold">4. คงเหลือ</th>
                            <th class="p-3 text-center">5. วันที่ชำระ</th>
                            <th class="p-3 text-center">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-200 dark:divide-slate-700">
                        <tr><td colspan="8" class="p-10 text-center text-gray-400 italic">กรุณากดปุ่มอัปเดตข้อมูล</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="statusMsg" class="hidden fixed top-6 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg z-[60]"></div>

    <script>
        let rawData = [];
        let filteredDataGlobal = [];
        let selectedExpenseTypes = new Set();
        lucide.createIcons();

        // UI Toggle for Multi-select
        const dropBtn = document.getElementById('expenseTypeDropdownBtn');
        const menu = document.getElementById('expenseMenu');
        dropBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('hidden');
        });
        document.addEventListener('click', () => menu.classList.add('hidden'));
        menu.addEventListener('click', (e) => e.stopPropagation());

        function parseThaiDate(dateStr) {
            if (!dateStr || dateStr === '-') return new Date(0);
            const months = { 'ม.ค.': 0, 'ก.พ.': 1, 'มี.ค.': 2, 'เม.ย.': 3, 'พ.ค.': 4, 'มิ.ย.': 5, 'ก.ค.': 6, 'ส.ค.': 7, 'ก.ย.': 8, 'ต.ค.': 9, 'พ.ย.': 10, 'ธ.ค.': 11 };
            const parts = dateStr.trim().split(' ');
            if (parts.length < 3) return new Date(0);
            const day = parseInt(parts[0]);
            const month = months[parts[1]] || 0;
            const year = parseInt(parts[2]) + 2443;
            return new Date(year, month, day);
        }

        async function fetchFromCloud() {
            const btn = document.getElementById('syncCloudBtn');
            const icon = document.getElementById('syncIcon');
            btn.disabled = true; icon.classList.add('animate-spin');
            try {
                const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFdX-ihIPt_qLmJz_6gYvOoP7Ql1d4ffu3BQgJBu9omjgRmmoX_w0_K00m_vvXHA/pub?output=csv";
                const response = await fetch(`${SHEET_CSV_URL}&t=${new Date().getTime()}`);
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).map(line => {
                    const res = []; let c = "", q = false;
                    for (let char of line) {
                        if (char === '"') q = !q;
                        else if (char === ',' && !q) { res.push(c); c = ""; }
                        else c += char;
                    }
                    res.push(c); return res;
                });
                
                const parseNum = (v) => v ? parseFloat(String(v).replace(/[^\d.-]/g, '')) || 0 : 0;
                const expenses = new Set();
                
                rawData = rows.slice(1).filter(r => r[2] || r[3]).map(row => {
                    const expType = row[12]?.trim() || 'ไม่ระบุ';
                    expenses.add(expType);
                    return {
                        date: row[1]?.trim() || '-',
                        creditor: row[2]?.trim() || '-',
                        invoice: row[3]?.trim() || '-',
                        amount: parseNum(row[4]),
                        paid: parseNum(row[5]),
                        adjustment: parseNum(row[6]),
                        balance: parseNum(row[7]),
                        paymentDate: row[8]?.trim() || '-',
                        expenseType: expType,
                        department: row[13]?.trim() || 'ไม่ระบุ'
                    };
                });

                // Generate Checkboxes
                const container = document.getElementById('expenseCheckboxes');
                const sortedExps = Array.from(expenses).sort((a,b) => a.localeCompare(b, 'th'));
                container.innerHTML = sortedExps.map(exp => `
                    <label class="flex items-center gap-2 p-2 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-lg cursor-pointer transition-colors">
                        <input type="checkbox" value="${exp}" checked class="expense-item w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs text-gray-700 dark:text-gray-300">${exp}</span>
                    </label>
                `).join('');

                // Default all selected
                selectedExpenseTypes = new Set(sortedExps);
                
                // Add Checkbox Events
                document.querySelectorAll('.expense-item').forEach(el => {
                    el.addEventListener('change', () => {
                        if(el.checked) selectedExpenseTypes.add(el.value);
                        else selectedExpenseTypes.delete(el.value);
                        updateMultiSelectLabel();
                        applyFilters();
                    });
                });

                document.getElementById('checkAllExpenses').addEventListener('change', (e) => {
                    const items = document.querySelectorAll('.expense-item');
                    items.forEach(item => {
                        item.checked = e.target.checked;
                        if(e.target.checked) selectedExpenseTypes.add(item.value);
                        else selectedExpenseTypes.delete(item.value);
                    });
                    updateMultiSelectLabel();
                    applyFilters();
                });

                updateMultiSelectLabel();
                applyFilters();
                showStatus("อัปเดตข้อมูลสำเร็จ!", "success");
            } catch (err) { 
                console.error(err);
                showStatus("โหลดข้อมูลไม่สำเร็จ", "error"); 
            } finally { 
                btn.disabled = false; icon.classList.remove('animate-spin'); 
            }
        }

        function updateMultiSelectLabel() {
            const label = document.getElementById('selectedExpenseLabel');
            const totalItems = document.querySelectorAll('.expense-item').length;
            const selectedCount = selectedExpenseTypes.size;
            
            if (selectedCount === 0) label.innerText = "ไม่ได้เลือก";
            else if (selectedCount === totalItems) label.innerText = "ทั้งหมด";
            else label.innerText = `เลือกแล้ว ${selectedCount} รายการ`;
        }

        function applyFilters() {
            const searchC = document.getElementById('searchCreditor').value.toLowerCase();
            const searchI = document.getElementById('searchInvoice').value.toLowerCase();
            const sk = document.getElementById('filterStatus').value;

            filteredDataGlobal = rawData.filter(d => {
                const matchC = d.creditor.toLowerCase().includes(searchC);
                const matchI = d.invoice.toLowerCase().includes(searchI);
                const matchE = selectedExpenseTypes.has(d.expenseType);
                let matchS = true;
                if (sk === 'Paid') matchS = d.balance <= 0;
                else if (sk === 'Unpaid') matchS = d.balance > 0;
                
                return matchC && matchI && matchE && matchS;
            });

            filteredDataGlobal.sort((a, b) => parseThaiDate(b.date) - parseThaiDate(a.date));
            updateUI();
        }

        function updateUI() {
            const data = filteredDataGlobal;
            const format = (v) => v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // 1. Stats Update
            const total = data.reduce((s, r) => s + r.amount, 0);
            const paid = data.reduce((s, r) => s + r.paid, 0);
            const adj = data.reduce((s, r) => s + r.adjustment, 0);
            const bal = data.reduce((s, r) => s + r.balance, 0);

            document.getElementById('statTotal').innerText = format(total);
            document.getElementById('statPaid').innerText = format(paid);
            document.getElementById('statAdjustment').innerText = format(adj);
            document.getElementById('statBalance').innerText = format(bal);

            // 2. Summary Table
            const expMap = {};
            data.forEach(r => {
                if (!expMap[r.expenseType]) expMap[r.expenseType] = { count: 0, paid: 0, adj: 0, bal: 0 };
                expMap[r.expenseType].count++;
                expMap[r.expenseType].paid += r.paid;
                expMap[r.expenseType].adj += r.adjustment;
                expMap[r.expenseType].bal += r.balance;
            });

            const sortedEntries = Object.entries(expMap).sort((a, b) => a[0].localeCompare(b[0], 'th'));
            document.getElementById('summaryTableBody').innerHTML = sortedEntries.map(([type, stats]) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors">
                    <td class="p-3 font-semibold text-gray-700 dark:text-gray-300">${type}</td>
                    <td class="p-3 text-center">${stats.count}</td>
                    <td class="p-3 text-right text-green-600 font-medium">${format(stats.paid)}</td>
                    <td class="p-3 text-right text-orange-500">${format(stats.adj)}</td>
                    <td class="p-3 text-right text-red-600 font-bold">${format(stats.bal)}</td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-4 text-center text-gray-400 italic">ไม่มีข้อมูล</td></tr>';

            // 3. Detail Table
            document.getElementById('dataTableBody').innerHTML = data.map(r => {
                const isPaid = r.balance <= 0;
                const statusColor = isPaid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                return `
                    <tr class="hover:bg-indigo-50/50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="p-3 text-gray-500">${r.date}</td>
                        <td class="p-3">
                            <div class="font-bold text-gray-800 dark:text-gray-100 leading-tight">${r.creditor}</div>
                            <div class="text-[9px] text-indigo-500 font-mono mt-1">${r.invoice}</div>
                        </td>
                        <td class="p-3 text-right font-medium">${format(r.amount)}</td>
                        <td class="p-3 text-right text-green-600">${format(r.paid)}</td>
                        <td class="p-3 text-right text-orange-500">${format(r.adjustment)}</td>
                        <td class="p-3 text-right font-bold text-red-600">${format(r.balance)}</td>
                        <td class="p-3 text-center text-gray-500">${r.paymentDate}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${statusColor}">${isPaid ? 'จ่ายครบ' : 'ค้าง'}</span>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="8" class="p-10 text-center text-gray-400">ไม่พบรายการ</td></tr>';
        }

        function showStatus(m, t) {
            const el = document.getElementById('statusMsg');
            el.innerText = m;
            el.className = `fixed top-6 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg z-[60] block ${t === 'success' ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        document.getElementById('syncCloudBtn').addEventListener('click', fetchFromCloud);
        ['searchCreditor', 'searchInvoice', 'filterStatus'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('moonIcon').classList.toggle('hidden', isDark);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDark);
        });

        // Initial fetch if needed
        // fetchFromCloud(); 
    </script>
</body>
</html>
